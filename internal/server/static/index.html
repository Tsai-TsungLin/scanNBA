<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA ä»Šæ—¥è³½äº‹åˆ†æ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .date {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.5em;
            padding: 50px;
        }

        .game-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .game-card:hover {
            transform: translateY(-5px);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            cursor: pointer;
            user-select: none;
        }

        .game-header:hover {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
        }

        .matchup {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }

        .home-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.6em;
            margin-left: 5px;
            vertical-align: middle;
        }

        .game-time {
            font-size: 1.2em;
            color: #667eea;
            font-weight: bold;
        }

        .game-time.finished {
            color: #28a745;
        }

        .game-time.live {
            color: #dc3545;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .spread-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .spread-info .label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .spread-info .values {
            font-size: 1.3em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .spread-info.has-periods .values {
            justify-content: flex-start;
        }

        .spread-basic {
            font-size: 1em;
            white-space: nowrap;
        }

        /* é è¨­é¡¯ç¤ºå®Œæ•´æ–‡å­— */
        .spread-desktop {
            display: inline;
        }

        .spread-mobile {
            display: none;
        }

        .spread-arrow {
            margin: 0 10px;
            font-size: 1.2em;
        }

        .period-scores-table {
            display: inline-block;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            vertical-align: middle;
        }

        .betting-results {
            display: inline-block;
            background: white;
            border-radius: 8px;
            padding: 8px 12px;
            vertical-align: middle;
        }

        .betting-results table {
            border-collapse: collapse;
            font-size: 0.75em;
        }

        .betting-results th {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            text-align: center;
            font-weight: bold;
        }

        .betting-results td {
            padding: 4px 8px;
            color: #333;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .betting-results .row-label {
            background: #f8f9fa;
            font-weight: bold;
            color: #667eea;
            text-align: left;
        }

        .betting-results .win {
            color: #28a745;
            font-weight: bold;
        }

        .betting-results .lose {
            color: #dc3545;
            font-weight: bold;
        }

        .period-scores-table table {
            border-collapse: collapse;
            font-size: 0.75em;
        }

        .period-scores-table th {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            font-weight: bold;
            text-align: center;
        }

        .period-scores-table td {
            padding: 4px 8px;
            text-align: center;
            border-right: 1px solid #e0e0e0;
            color: #333;
        }

        .period-scores-table td:last-child {
            border-right: none;
            font-weight: bold;
            background: #f8f9fa;
        }

        .period-scores-table tr:first-child td {
            border-bottom: 1px solid #e0e0e0;
        }

        .no-spread {
            background: #e0e0e0;
            color: #666;
        }

        .injuries-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .injury-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .injury-box.away {
            border-left-color: #764ba2;
        }

        .injury-box h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .team-history-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .team-history {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .team-history.away {
            border-left-color: #764ba2;
        }

        .team-history h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .team-history h3:hover {
            background: #e9ecef;
            padding: 5px;
            border-radius: 5px;
        }

        .history-toggle {
            font-size: 0.7em;
            transition: transform 0.3s ease;
        }

        .team-history.collapsed .history-toggle {
            transform: rotate(-90deg);
        }

        .history-record {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 10px;
        }

        .record-item {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9em;
            transition: transform 0.2s;
        }

        .record-item.win {
            background: #28a745;
            color: white;
        }

        .record-item.loss {
            background: #dc3545;
            color: white;
        }

        .history-summary {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .history-details {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .team-history.collapsed .history-details {
            max-height: 0;
        }

        .history-game {
            padding: 10px;
            margin-top: 8px;
            background: white;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #ddd;
            min-height: 60px;
        }

        .history-game.win {
            border-left-color: #28a745;
        }

        .history-game.loss {
            border-left-color: #dc3545;
        }

        .history-game-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .history-game-header {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .history-game-date {
            font-size: 0.85em;
            color: #666;
            white-space: nowrap;
        }

        .history-game-opponent {
            font-weight: bold;
            color: #333;
            font-size: 0.95em;
        }

        .history-game-score {
            font-size: 0.9em;
            font-weight: bold;
            color: #667eea;
            margin-top: 2px;
        }

        .history-game-middle {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-game-spread {
            font-size: 0.75em;
            color: #667eea;
            font-weight: bold;
            white-space: nowrap;
            padding: 2px 6px;
            background: #f0f0ff;
            border-radius: 4px;
        }

        .history-game-result {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.1em;
            color: white;
            flex-shrink: 0;
        }

        .history-game.win .history-game-result {
            background: #28a745;
        }

        .history-game.loss .history-game-result {
            background: #dc3545;
        }

        .special-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 5px;
            background: #ffd54f;
            color: #333;
        }

        .history-game {
            cursor: pointer;
        }

        .history-game:hover {
            background: #f0f0f0;
            transform: translateX(5px);
            transition: all 0.2s;
        }

        .venue-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            margin-left: 5px;
        }

        .injury-list {
            list-style: none;
        }

        .injury-item {
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #ddd;
        }

        .injury-item:last-child {
            margin-bottom: 0;
        }

        .injury-player {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
            font-size: 1em;
        }

        .injury-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 8px;
        }

        .injury-status.day-to-day {
            background: #ffc107;
            color: #333;
        }

        .injury-status.out {
            background: #dc3545;
            color: white;
        }

        .injury-status.questionable {
            background: #ff9800;
            color: white;
        }

        .injury-detail {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
            margin-top: 4px;
            display: none;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .injury-item.expanded .injury-detail {
            display: block;
        }

        .injury-item {
            cursor: pointer;
        }

        .injury-item:hover {
            background: #f8f9fa;
        }

        .game-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .game-card.collapsed .game-content {
            max-height: 0;
        }

        .toggle-icon {
            display: inline-block;
            margin-left: 10px;
            transition: transform 0.3s ease;
            font-size: 0.8em;
            color: #667eea;
        }

        .game-card.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .spread-preview {
            display: none;
            font-size: 0.9em;
            color: #667eea;
            margin-left: 15px;
            font-weight: normal;
        }

        .game-card.collapsed .spread-preview {
            display: inline;
        }

        .game-card.collapsed .game-content {
            display: none;
        }

        .no-injuries {
            color: #28a745;
            font-weight: bold;
            padding: 10px;
            text-align: center;
        }

        .player-stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .player-stats-wrapper {
            overflow-x: auto;
            margin: 10px 0;
        }

        .player-stats-table thead {
            background: #667eea;
            color: white;
        }

        .player-stats-table th {
            padding: 10px;
            text-align: left;
            font-size: 0.9em;
        }

        .player-stats-table td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .player-row {
            transition: background 0.2s;
        }

        .player-row:hover {
            background: #f8f9fa;
        }

        .player-stats-table td {
            color: #000;
        }


        .player-name-cell {
            width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .section-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tab-button {
            padding: 10px 20px;
            background: #e0e0e0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-button:hover {
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .date-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            position: relative;
        }

        .date-selector button {
            padding: 10px 15px;
            border: 2px solid white;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .date-selector button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* Calendar Picker Styles */
        .calendar-picker {
            position: relative;
            display: inline-block;
        }

        .calendar-input {
            padding: 10px 15px;
            border: 2px solid white;
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 150px;
            user-select: none;
        }

        .calendar-input:hover {
            background: white;
            transform: translateY(-2px);
        }

        .calendar-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            font-size: 1.2em;
        }

        .calendar-dropdown {
            position: absolute;
            top: calc(100% + 5px);
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            padding: 15px;
            z-index: 1000;
            display: none;
            min-width: 320px;
        }

        .calendar-dropdown.active {
            display: block;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 5px;
        }

        .calendar-month-select {
            font-size: 1em;
            font-weight: bold;
            color: #333;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: #667eea;
            transition: all 0.2s;
        }

        .calendar-nav-btn:hover {
            background: #667eea;
            color: white;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 5px;
        }

        .calendar-weekday {
            text-align: center;
            font-size: 0.85em;
            color: #666;
            font-weight: bold;
            padding: 8px 0;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.9em;
            color: #333;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            background: #f0f0ff;
        }

        .calendar-day.other-month {
            color: #ccc;
        }

        .calendar-day.selected {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .calendar-day.today {
            border: 2px solid #667eea;
        }

        /* Loading Modal */
        .loading-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-modal.active {
            display: flex;
        }

        .loading-modal-content {
            background: white;
            padding: 40px 60px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .loading-modal-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-modal-text {
            font-size: 1.2em;
            color: #333;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .header .date {
                font-size: 1em;
            }

            .matchup {
                font-size: 1.1em;
            }

            .spread-preview {
                font-size: 0.8em;
            }

            .game-card {
                padding: 15px;
                margin-bottom: 15px;
            }

            .injuries-section {
                grid-template-columns: 1fr;
            }

            .team-history-section {
                grid-template-columns: 1fr;
            }

            .injury-box, .team-history {
                padding: 12px;
            }

            /* ç¢ºä¿ injury-box å¯ä»¥å®¹ç´å¯æ»¾å‹•çš„è¡¨æ ¼ */
            .injury-box {
                overflow-x: visible;
            }

            /* è¡¨æ ¼æ©«å‘æ»¾å‹• */
            .player-stats-wrapper {
                overflow-x: scroll !important;
                -webkit-overflow-scrolling: touch;
                display: block !important;
                width: 100%;
            }

            .player-stats-table {
                min-width: 450px;
                font-size: 0.85em;
                display: table !important;
            }

            .player-stats-table th {
                padding: 6px 4px;
                font-size: 0.85em;
            }

            .player-stats-table td {
                padding: 6px 4px;
            }

            .player-name-cell {
                width: 120px;
                font-size: 0.9em;
            }

            .period-scores-table table {
                font-size: 0.5em;
            }

            .period-scores-table th,
            .period-scores-table td {
                padding: 2px 4px;
            }

            .betting-results table {
                font-size: 0.5em;
            }

            .betting-results th,
            .betting-results td {
                padding: 2px 4px;
            }

            /* æ—¥æ›†é¸æ“‡å™¨å„ªåŒ– */
            .calendar-dropdown {
                min-width: 280px;
                max-width: 90vw;
            }

            .date-selector {
                flex-wrap: wrap;
                gap: 8px;
            }

            .date-selector button {
                padding: 8px 12px;
                font-size: 0.85em;
            }

            .calendar-input {
                padding: 8px 12px;
                font-size: 0.9em;
                min-width: 130px;
            }

            /* å¢åŠ è§¸æ‘¸å€åŸŸ */
            .game-header {
                padding: 10px;
                min-height: 60px;
            }

            .history-game {
                padding: 8px;
                min-height: 50px;
            }

            .record-item {
                width: 24px;
                height: 24px;
                font-size: 0.75em;
            }

            /* å„ªåŒ–æ¯”è³½è³‡è¨Šé¡¯ç¤º */
            .spread-info .values {
                flex-direction: column;
                gap: 10px;
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .spread-info.has-periods .values {
                align-items: center;
            }

            /* ç¸®å°ç›¤å£è³‡è¨Šå­—é«” */
            .spread-basic {
                font-size: 0.7em;
                word-break: break-word;
            }

            /* æ‰‹æ©Ÿç‰ˆéš±è—å®Œæ•´æ–‡å­—ï¼Œåªé¡¯ç¤ºç°¡åŒ–ç‰ˆ */
            .spread-mobile {
                display: inline;
            }

            .spread-desktop {
                display: none;
            }

            /* ç¸®å°æ­·å²æ¯”è³½çš„ W/L åœ“åœˆ */
            .history-game-result {
                width: 32px;
                height: 32px;
                font-size: 0.9em;
            }

            /* å„ªåŒ–éšŠä¼åç¨±é¡¯ç¤º */
            .period-scores-table td:first-child {
                font-size: 0.9em;
                max-width: 40px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .game-time {
                font-size: 1em;
            }

            /* Tab æŒ‰éˆ•å„ªåŒ– */
            .tab-button {
                padding: 8px 15px;
                font-size: 0.9em;
            }

            /* æ­·å²æ¯”è³½è©³æƒ… */
            .history-game-header {
                font-size: 0.9em;
            }

            .history-game-score {
                font-size: 0.85em;
            }

            .venue-badge, .special-badge {
                font-size: 0.65em;
                padding: 1px 4px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Modal -->
    <div id="loadingModal" class="loading-modal">
        <div class="loading-modal-content">
            <div class="loading-modal-spinner"></div>
            <div class="loading-modal-text">ğŸ€ è¼‰å…¥æ¯”è³½è³‡æ–™ä¸­...</div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ€ NBA è³½äº‹åˆ†æ</h1>
            <div class="date" id="gameDate">è¼‰å…¥ä¸­...</div>
            <div class="date-selector">
                <button onclick="loadToday()">ä»Šå¤©</button>
                <button onclick="loadTomorrow()">æ˜å¤©</button>
                <div class="calendar-picker">
                    <div class="calendar-input" id="calendarInput" onclick="toggleCalendar()">
                        <span id="selectedDateText">2025/10/14</span>
                    </div>
                    <div class="calendar-dropdown" id="calendarDropdown">
                        <div class="calendar-header">
                            <select class="calendar-month-select" id="monthSelect" onchange="renderCalendar()">
                                <option value="0">January 2025</option>
                                <option value="1">February 2025</option>
                                <option value="2">March 2025</option>
                                <option value="3">April 2025</option>
                                <option value="4">May 2025</option>
                                <option value="5">June 2025</option>
                                <option value="6">July 2025</option>
                                <option value="7">August 2025</option>
                                <option value="8">September 2025</option>
                                <option value="9">October 2025</option>
                                <option value="10">November 2025</option>
                                <option value="11">December 2025</option>
                            </select>
                            <div class="calendar-nav">
                                <button class="calendar-nav-btn" onclick="changeMonth(-1)">â—€</button>
                                <button class="calendar-nav-btn" onclick="changeMonth(1)">â–¶</button>
                            </div>
                        </div>
                        <div class="calendar-weekdays">
                            <div class="calendar-weekday">S</div>
                            <div class="calendar-weekday">M</div>
                            <div class="calendar-weekday">T</div>
                            <div class="calendar-weekday">W</div>
                            <div class="calendar-weekday">T</div>
                            <div class="calendar-weekday">F</div>
                            <div class="calendar-weekday">S</div>
                        </div>
                        <div class="calendar-days" id="calendarDays">
                            <!-- Days will be generated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="content" class="loading">
            <div>è¼‰å…¥æ¯”è³½è³‡æ–™ä¸­...</div>
        </div>
    </div>

    <script>
        let currentDate = null;
        let isLoading = false;
        let gamesCache = {}; // å¿«å–ï¼š{ "2025-10-14": { basic: {...}, detailed: {...} } }
        let calendarYear = 2025;
        let calendarMonth = 9; // October (0-indexed)
        let selectedDate = null;

        async function loadGames(dateStr = '', forceReload = false) {
            // é˜²æ­¢é‡è¤‡è¼‰å…¥
            if (isLoading) {
                console.log('æ­£åœ¨è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...');
                return;
            }

            try {
                isLoading = true;

                // é¡¯ç¤º Loading Modal
                showLoadingModal();

                // æª¢æŸ¥å¿«å–
                if (!forceReload && gamesCache[dateStr]) {
                    // å…ˆé¡¯ç¤ºåŸºæœ¬è³‡è¨Šï¼ˆå¿«é€Ÿæ¸²æŸ“ï¼‰
                    renderGamesBasic(gamesCache[dateStr], dateStr);
                    hideLoadingModal();
                    isLoading = false;
                    return;
                }

                const url = dateStr ? `/api/games?date=${dateStr}` : '/api/games';
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // å„²å­˜åˆ°å¿«å–
                gamesCache[dateStr] = data;

                renderGames(data);
                hideLoadingModal();
                isLoading = false;
            } catch (error) {
                hideLoadingModal();
                isLoading = false;
                document.getElementById('content').innerHTML = `
                    <div class="error">
                        <h2>è¼‰å…¥å¤±æ•—</h2>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function showLoadingModal() {
            document.getElementById('loadingModal').classList.add('active');
        }

        function hideLoadingModal() {
            document.getElementById('loadingModal').classList.remove('active');
        }

        // å¿«é€Ÿæ¸²æŸ“åŸºæœ¬è³‡è¨Šï¼ˆå¾å¿«å–ï¼‰
        function renderGamesBasic(data, dateStr) {
            renderGames(data); // ä½¿ç”¨å®Œæ•´çš„æ¸²æŸ“å‡½æ•¸
        }

        function parseInjury(injuryText) {
            // è§£ææ ¼å¼: "Name Status Date: Detail"
            const parts = injuryText.split(' ');

            let playerName = '';
            let status = '';
            let detail = '';
            let dateStr = '';

            // æ‰¾åˆ°ç‹€æ…‹é—œéµå­—çš„ä½ç½®
            let statusIndex = -1;
            const statusKeywords = ['Day-To-Day', 'Out', 'Questionable', 'Doubtful', 'Probable'];

            for (let i = 0; i < parts.length; i++) {
                if (statusKeywords.includes(parts[i])) {
                    statusIndex = i;
                    status = parts[i];
                    break;
                }
            }

            if (statusIndex > 0) {
                playerName = parts.slice(0, statusIndex).join(' ');
                const remainingText = parts.slice(statusIndex + 1).join(' ');

                // æå–æ—¥æœŸ (æ ¼å¼: Oct 8, Sep 30 ç­‰)
                const dateMatch = remainingText.match(/([A-Z][a-z]{2})\s+(\d+)/);
                if (dateMatch) {
                    dateStr = dateMatch[0]; // "Oct 8" or "Sep 30"
                }

                detail = remainingText;
            } else {
                playerName = injuryText;
            }

            return { playerName, status, detail, dateStr };
        }

        function parseDateStr(dateStr) {
            // å°‡ "Oct 8" è½‰æ›ç‚ºå¯æ’åºçš„æ—¥æœŸ
            if (!dateStr) return new Date(0);

            const months = {
                'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
            };

            const parts = dateStr.split(' ');
            const month = months[parts[0]];
            const day = parseInt(parts[1]);

            const year = new Date().getFullYear();
            return new Date(year, month, day);
        }

        function sortInjuriesByDate(injuries) {
            return injuries.map(inj => ({
                text: inj,
                parsed: parseInjury(inj),
                date: parseDateStr(parseInjury(inj).dateStr)
            }))
            .sort((a, b) => b.date - a.date) // æœ€æ–°çš„åœ¨å‰
            .map(item => item.text);
        }

        function getStatusClass(status) {
            if (status === 'Day-To-Day') return 'day-to-day';
            if (status === 'Out') return 'out';
            if (status === 'Questionable' || status === 'Doubtful') return 'questionable';
            return 'day-to-day';
        }

        function renderInjuries(injuries) {
            if (injuries.length === 0) {
                return '<div class="no-injuries">âœ“ ç„¡å‚·å…µ</div>';
            }

            // æŒ‰æ—¥æœŸæ’åº
            const sortedInjuries = sortInjuriesByDate(injuries);

            return sortedInjuries.map((injury, idx) => {
                const parsed = parseInjury(injury);
                const statusClass = getStatusClass(parsed.status);

                return `
                    <div class="injury-item" onclick="toggleInjuryDetail(this)">
                        <div class="injury-player">
                            ${parsed.playerName}
                            ${parsed.status ? `<span class="injury-status ${statusClass}">${parsed.status}</span>` : ''}
                        </div>
                        ${parsed.detail ? `<div class="injury-detail">${parsed.detail}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function toggleInjuryDetail(element) {
            element.classList.toggle('expanded');
        }

        function toggleGame(headerElement) {
            const gameCard = headerElement.closest('.game-card');
            gameCard.classList.toggle('collapsed');
        }

        function toggleHistory(element) {
            const historyBox = element.closest('.team-history');
            historyBox.classList.toggle('collapsed');
        }

        function switchTab(gameCard, tabName) {
            // åˆ‡æ›æ¨™ç±¤æŒ‰éˆ•ç‹€æ…‹
            const tabs = gameCard.querySelectorAll('.tab-button');
            tabs.forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // åˆ‡æ›å…§å®¹é¡¯ç¤º
            const contents = gameCard.querySelectorAll('.tab-content');
            contents.forEach(content => {
                if (content.dataset.tab === tabName) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        function renderPeriodScores(periodScores, homeTeamName, awayTeamName, homeTotal, awayTotal) {
            if (!periodScores) {
                return '';
            }

            return `
                <div class="period-scores-table">
                    <table>
                        <thead>
                            <tr>
                                <th>éšŠä¼</th>
                                <th>Q1</th>
                                <th>Q2</th>
                                <th>Q3</th>
                                <th>Q4</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="text-align: left; font-weight: bold">${awayTeamName}</td>
                                <td>${periodScores.awayPeriods[0]}</td>
                                <td>${periodScores.awayPeriods[1]}</td>
                                <td>${periodScores.awayPeriods[2]}</td>
                                <td>${periodScores.awayPeriods[3]}</td>
                                <td>${awayTotal}</td>
                            </tr>
                            <tr>
                                <td style="text-align: left; font-weight: bold">${homeTeamName}</td>
                                <td>${periodScores.homePeriods[0]}</td>
                                <td>${periodScores.homePeriods[1]}</td>
                                <td>${periodScores.homePeriods[2]}</td>
                                <td>${periodScores.homePeriods[3]}</td>
                                <td>${homeTotal}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderBettingResults(periodScores, homeSpread, awayTotal, homeTotal) {
            if (!periodScores) {
                return '';
            }

            // è¨ˆç®—ä¸ŠåŠå ´æ¯”åˆ† (Q1 + Q2)
            const halfAwayScore = periodScores.awayPeriods[0] + periodScores.awayPeriods[1];
            const halfHomeScore = periodScores.homePeriods[0] + periodScores.homePeriods[1];
            const halfTotal = halfAwayScore + halfHomeScore;

            // è¨ˆç®—å…¨å ´
            const fullTotal = awayTotal + homeTotal;

            // è®“åˆ†ç›¤å£
            const spreadValue = parseFloat(homeSpread) || 0;

            // ä¸ŠåŠå ´å¯¦éš›åˆ†å·®ï¼ˆä¸»éšŠ - å®¢éšŠï¼‰
            const halfDiff = halfHomeScore - halfAwayScore;
            const halfSpreadText = halfDiff > 0 ? `ä¸»-${halfDiff}` : halfDiff < 0 ? `å®¢-${Math.abs(halfDiff)}` : 'å¹³';

            // ä¸ŠåŠå ´è®“åˆ†çµæœï¼ˆä¸»éšŠåŠ è®“åˆ†å¾Œï¼‰
            const halfSpreadResult = halfDiff + spreadValue;
            const halfSpreadClass = halfSpreadResult > 0 ? 'win' : halfSpreadResult < 0 ? 'lose' : '';

            // å…¨å ´å¯¦éš›åˆ†å·®ï¼ˆä¸»éšŠ - å®¢éšŠï¼‰
            const fullDiff = homeTotal - awayTotal;
            const fullSpreadText = fullDiff > 0 ? `ä¸»-${fullDiff}` : fullDiff < 0 ? `å®¢-${Math.abs(fullDiff)}` : 'å¹³';

            // å…¨å ´è®“åˆ†çµæœï¼ˆä¸»éšŠåŠ è®“åˆ†å¾Œï¼‰
            const fullSpreadResult = fullDiff + spreadValue;
            const fullSpreadClass = fullSpreadResult > 0 ? 'win' : fullSpreadResult < 0 ? 'lose' : '';

            return `
                <div class="betting-results">
                    <table>
                        <thead>
                            <tr>
                                <th></th>
                                <th>ä¸ŠåŠ</th>
                                <th>å…¨å ´</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="row-label">è®“åˆ†</td>
                                <td class="${halfSpreadClass}">${halfSpreadText}</td>
                                <td class="${fullSpreadClass}">${fullSpreadText}</td>
                            </tr>
                            <tr>
                                <td class="row-label">å¤§å°</td>
                                <td>${halfTotal}</td>
                                <td>${fullTotal}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderPlayerStats(players, teamName, gameStatus) {
            if (!players || players.length === 0) {
                return '<p style="text-align: center; color: #666;">æš«ç„¡çƒå“¡æ•¸æ“š</p>';
            }

            const rows = players.map(player => {
                // åªæœ‰é€²è¡Œä¸­çš„æ¯”è³½æ‰é¡¯ç¤º on-court æ¨™è¨˜
                const showOnCourt = gameStatus === 2 && player.onCourt;
                const onCourtIndicator = showOnCourt ? 'ğŸ€ ' : '';

                return `
                    <tr class="player-row">
                        <td class="player-name-cell">${onCourtIndicator}${player.name}</td>
                        <td style="text-align: center">${player.position}</td>
                        <td style="text-align: center">${player.points}</td>
                        <td style="text-align: center">${player.rebounds}</td>
                        <td style="text-align: center">${player.assists}</td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="player-stats-wrapper">
                    <table class="player-stats-table">
                        <thead>
                            <tr>
                                <th style="width: 200px; text-align: left">çƒå“¡</th>
                                <th style="width: 60px; text-align: center">ä½ç½®</th>
                                <th style="text-align: center; width: 60px">å¾—åˆ†</th>
                                <th style="text-align: center; width: 60px">ç±ƒæ¿</th>
                                <th style="text-align: center; width: 60px">åŠ©æ”»</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderTeamHistory(history, teamName, isAway = false) {
            if (!history || !history.recentGames || history.recentGames.length === 0) {
                return '';
            }

            // ç°¡åŒ–é¡¯ç¤ºï¼šåªé¡¯ç¤º W/Lï¼ˆéç›¤çµæœï¼‰
            const records = history.recentGames.map(game => {
                const resultClass = game.spreadResult === 'W' ? 'win' : 'loss';
                return `<div class="record-item ${resultClass}">${game.spreadResult}</div>`;
            }).join('');

            // è©³ç´°é¡¯ç¤ºï¼šé¡¯ç¤ºå°æˆ°éšŠä¼ç­‰è³‡è¨Š
            const detailGames = history.recentGames.map(game => {
                const spreadResultClass = game.spreadResult === 'W' ? 'win' : 'loss';
                const venue = game.isHome ? 'ä¸»' : 'å®¢';

                // åˆ¤æ–·æ˜¯å¦ç‚ºã€Œè´çƒè¼¸ç›¤ã€æˆ–ã€Œè¼¸çƒè´ç›¤ã€ï¼ˆçµ±ä¸€ç”¨é»ƒè‰²æ¨™è¨˜ï¼‰
                let specialBadge = '';
                if (game.gameResult !== game.spreadResult) {
                    if (game.gameResult === 'W' && game.spreadResult === 'L') {
                        specialBadge = '<span class="special-badge">è´çƒè¼¸ç›¤</span>';
                    } else if (game.gameResult === 'L' && game.spreadResult === 'W') {
                        specialBadge = '<span class="special-badge">è¼¸çƒè´ç›¤</span>';
                    }
                }

                // ä½¿ç”¨ NBA åŸå§‹æ—¥æœŸé€²è¡Œè·³è½‰ï¼ˆgameDate å·²ç¶“æ˜¯ "2025-10-07" æ ¼å¼ï¼‰
                const queryDate = game.gameDate || game.date.replace(/\//g, '-');

                return `
                    <div class="history-game ${spreadResultClass}"
                         data-game-id="${game.gameId}"
                         data-game-date="${queryDate}"
                         onclick="navigateToHistoricalGame('${game.gameId}', '${queryDate}', event)">
                        <div class="history-game-info">
                            <div class="history-game-header">
                                <span class="history-game-date">${game.date}</span>
                                <span class="venue-badge">${venue}å ´</span>
                                <span class="history-game-opponent">${game.vsIndicator} ${game.opponent}</span>
                                ${specialBadge}
                            </div>
                            <div class="history-game-score">${game.score}</div>
                        </div>
                        <div class="history-game-result">${game.spreadResult}</div>
                    </div>
                `;
            }).join('');

            const winRate = ((history.winCount / (history.winCount + history.lossCount)) * 100).toFixed(0);
            const awayClass = isAway ? 'away' : '';

            return `
                <div class="team-history ${awayClass} collapsed">
                    <h3 onclick="toggleHistory(this)">
                        <span>ğŸ“Š ${teamName} è¿‘æœŸæˆ°ç¸¾</span>
                        <span class="history-toggle">â–¼</span>
                    </h3>
                    <div class="history-record">
                        ${records}
                    </div>
                    <div class="history-summary">
                        è¿‘ ${history.recentGames.length} å ´: ${history.winCount} å‹ ${history.lossCount} æ•— (å‹ç‡ ${winRate}%)
                    </div>
                    <div class="history-details">
                        ${detailGames}
                    </div>
                </div>
            `;
        }

        function renderGames(data) {
            document.getElementById('gameDate').textContent = data.date;

            if (!data.games || data.games.length === 0) {
                document.getElementById('content').innerHTML = `
                    <div class="game-card">
                        <p style="text-align: center; color: #666;">ä»Šå¤©æ²’æœ‰æ¯”è³½</p>
                    </div>
                `;
                return;
            }

            // æŒ‰ç…§æ¯”è³½æ™‚é–“æ’åºï¼ˆä½¿ç”¨ gameTimeUTCï¼‰
            const sortedGames = [...data.games].sort((a, b) => {
                return new Date(a.gameTimeUTC) - new Date(b.gameTimeUTC);
            });

            const html = sortedGames.map((game, index) => {
                // æ ¹æ“šæ¯”è³½ç‹€æ…‹æ±ºå®šé¡¯ç¤ºå…§å®¹
                let spreadLabel = 'ä¸»éšŠè®“åˆ†';
                let timeClass = '';
                let displayScore = '';

                if (game.gameStatus === 1) {
                    // æœªé–‹å§‹ï¼šé¡¯ç¤ºé–‹ç›¤å’Œç•¶å‰ç›¤å£
                    spreadLabel = 'è®“åˆ†ç›¤å£';
                } else if (game.gameStatus === 2) {
                    // é€²è¡Œä¸­ï¼šé¡¯ç¤ºé–‹è³½å‰ç›¤å£ï¼ˆNBA API ä¸æä¾›å³æ™‚æ›´æ–°ï¼‰
                    spreadLabel = 'é–‹è³½å‰ç›¤å£';
                    timeClass = 'live';
                    displayScore = game.scoreDisplay;
                } else if (game.gameStatus === 3) {
                    // å·²çµæŸï¼šé¡¯ç¤ºé–‹è³½å‰ç›¤å£
                    spreadLabel = 'é–‹è³½å‰ç›¤å£';
                    timeClass = 'finished';
                    displayScore = game.scoreDisplay;
                }

                const periodScoresHTML = renderPeriodScores(
                    game.periodScores,
                    game.homeTeam.nameCN,
                    game.awayTeam.nameCN,
                    game.homeScore,
                    game.awayScore
                );

                const bettingResultsHTML = renderBettingResults(
                    game.periodScores,
                    game.spread.current,
                    game.awayScore,
                    game.homeScore
                );

                const hasPeriods = game.periodScores ? 'has-periods' : '';

                // æ ¹æ“šæ¯”è³½ç‹€æ…‹é¡¯ç¤ºä¸åŒçš„ç›¤å£è³‡è¨Š
                let spreadHTML;
                if (game.spread.hasData) {
                    if (game.gameStatus === 1) {
                        // æœªé–‹å§‹ï¼šé¡¯ç¤ºé–‹ç›¤å’Œç•¶å‰ç›¤å£
                        spreadHTML = `
                            <div class="spread-info ${hasPeriods}">
                                <div class="label">${spreadLabel}</div>
                                <div class="values">
                                    <div class="spread-basic">
                                        <span class="spread-desktop">é–‹ç›¤ ${game.spread.opening} â†’ ç•¶å‰ ${game.spread.current}</span>
                                        <span class="spread-mobile">${game.spread.opening} â†’ ${game.spread.current}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // é€²è¡Œä¸­æˆ–å·²çµæŸï¼šé¡¯ç¤ºé–‹è³½å‰ç›¤å£ + æ¯”åˆ† + å„ç¯€å¾—åˆ† + è®“åˆ†çµæœ
                        spreadHTML = `
                            <div class="spread-info ${hasPeriods}">
                                <div class="label">${spreadLabel}</div>
                                <div class="values">
                                    <div class="spread-basic">
                                        ä¸»éšŠ ${game.spread.current}
                                        ${displayScore ? `<span class="spread-arrow">â–¶</span> ${displayScore}` : ''}
                                    </div>
                                    ${periodScoresHTML}
                                    ${bettingResultsHTML}
                                </div>
                            </div>
                        `;
                    }
                } else if (game.gameStatus === 3 && game.periodScores) {
                    // å·²çµæŸä½†ç„¡ç›¤å£ï¼šé¡¯ç¤ºæ¯”åˆ†çµæœ
                    spreadHTML = `
                        <div class="spread-info no-spread ${hasPeriods}">
                            <div class="label">æ¯”è³½çµæœ</div>
                            <div class="values" style="justify-content: center;">
                                ${periodScoresHTML}
                            </div>
                        </div>
                    `;
                } else {
                    // å…¶ä»–æƒ…æ³ï¼šæš«ç„¡è³‡æ–™
                    spreadHTML = `
                        <div class="spread-info no-spread">
                            <div class="values">æš«ç„¡è®“åˆ†è³‡æ–™</div>
                        </div>
                    `;
                }

                const spreadPreview = game.spread.hasData
                    ? `${game.spread.current} ${displayScore}`
                    : (game.gameStatus === 3 && displayScore ? displayScore : 'ç„¡è³ ç‡');

                return `
                    <div class="game-card collapsed">
                        <div class="game-header" onclick="toggleGame(this)">
                            <div class="matchup">
                                ${index + 1}. ${game.awayTeam.nameCN} @ ${game.homeTeam.nameCN}<span class="home-badge">ä¸»</span>
                                <span class="spread-preview">${spreadPreview}</span>
                                <span class="toggle-icon">â–¼</span>
                            </div>
                            <div class="game-time ${timeClass}">${game.gameTime}</div>
                        </div>

                        <div class="game-content">
                            ${spreadHTML}

                            <div class="team-history-section">
                                ${renderTeamHistory(game.awayHistory, game.awayTeam.nameCN, true)}
                                ${renderTeamHistory(game.homeHistory, game.homeTeam.nameCN, false)}
                            </div>

                            ${(game.gameStatus === 2 || game.gameStatus === 3) && game.homePlayers && game.homePlayers.length > 0 ? `
                                <div class="section-tabs">
                                    <button class="tab-button active" data-tab="players" onclick="switchTab(this.closest('.game-card'), 'players')">
                                        ğŸ“Š çƒå“¡æ•¸æ“š
                                    </button>
                                    <button class="tab-button" data-tab="injuries" onclick="switchTab(this.closest('.game-card'), 'injuries')">
                                        ğŸ¥ å‚·å…µåå–®
                                    </button>
                                </div>

                                <div class="tab-content active" data-tab="players">
                                    <div class="injuries-section">
                                        <div class="injury-box away">
                                            <h3>ğŸƒ ${game.awayTeam.nameCN} çƒå“¡æ•¸æ“š</h3>
                                            ${renderPlayerStats(game.awayPlayers, game.awayTeam.nameCN, game.gameStatus)}
                                        </div>
                                        <div class="injury-box">
                                            <h3>ğŸ  ${game.homeTeam.nameCN} çƒå“¡æ•¸æ“š</h3>
                                            ${renderPlayerStats(game.homePlayers, game.homeTeam.nameCN, game.gameStatus)}
                                        </div>
                                    </div>
                                </div>

                                <div class="tab-content" data-tab="injuries">
                                    <div class="injuries-section">
                                        <div class="injury-box away">
                                            <h3>ğŸƒ ${game.awayTeam.nameCN} å‚·å…µ</h3>
                                            ${renderInjuries(game.awayInjuries)}
                                        </div>
                                        <div class="injury-box">
                                            <h3>ğŸ  ${game.homeTeam.nameCN} å‚·å…µ</h3>
                                            ${renderInjuries(game.homeInjuries)}
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="injuries-section">
                                    <div class="injury-box away">
                                        <h3>ğŸƒ ${game.awayTeam.nameCN} å‚·å…µ</h3>
                                        ${renderInjuries(game.awayInjuries)}
                                    </div>
                                    <div class="injury-box">
                                        <h3>ğŸ  ${game.homeTeam.nameCN} å‚·å…µ</h3>
                                        ${renderInjuries(game.homeInjuries)}
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('content').innerHTML = html;
        }

        function loadToday() {
            // å–å¾—å°åŒ—æ™‚é–“
            const now = new Date();
            // å°åŒ—æ˜¯ UTC+8ï¼ŒJavaScript ç”¨ UTC è¡¨ç¤º
            const taipeiTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));

            // å¦‚æœå°åŒ—æ™‚é–“é‚„æ²’åˆ° 14:00ï¼Œé¡¯ç¤ºæ˜¨å¤©
            let targetDate;
            if (taipeiTime.getHours() < 14) {
                targetDate = new Date(taipeiTime);
                targetDate.setDate(targetDate.getDate() - 1);
            } else {
                targetDate = taipeiTime;
            }

            const dateStr = targetDate.toISOString().split('T')[0];
            selectedDate = dateStr;
            currentDate = dateStr;

            // Update calendar display
            const displayText = `${targetDate.getFullYear()}/${String(targetDate.getMonth() + 1).padStart(2, '0')}/${String(targetDate.getDate()).padStart(2, '0')}`;
            document.getElementById('selectedDateText').textContent = displayText;

            loadGames(dateStr);
        }

        function loadTomorrow() {
            // å–å¾—ç•¶å‰é¡¯ç¤ºçš„æ—¥æœŸ
            let baseDate;
            if (currentDate) {
                // å¦‚æœå·²ç¶“æœ‰é¸æ“‡æ—¥æœŸï¼Œå¾ç•¶å‰æ—¥æœŸ +1
                baseDate = new Date(currentDate);
            } else {
                // å¦‚æœæ²’æœ‰é¸æ“‡æ—¥æœŸï¼Œä½¿ç”¨ã€Œä»Šå¤©ã€çš„é‚è¼¯å–å¾—åŸºæº–æ—¥æœŸ
                const now = new Date();
                const taipeiTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));

                if (taipeiTime.getHours() < 14) {
                    baseDate = new Date(taipeiTime);
                    baseDate.setDate(baseDate.getDate() - 1);
                } else {
                    baseDate = taipeiTime;
                }
            }

            // æ˜å¤© = åŸºæº–æ—¥æœŸ + 1
            const tomorrow = new Date(baseDate);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const dateStr = tomorrow.toISOString().split('T')[0];
            selectedDate = dateStr;
            currentDate = dateStr;

            // Update calendar display
            const displayText = `${tomorrow.getFullYear()}/${String(tomorrow.getMonth() + 1).padStart(2, '0')}/${String(tomorrow.getDate()).padStart(2, '0')}`;
            document.getElementById('selectedDateText').textContent = displayText;

            loadGames(dateStr);
        }

        // åˆå§‹åŒ–ï¼šè¼‰å…¥"ä»Šå¤©"çš„è³‡æ–™ï¼ˆæ ¹æ“š 14:00 è¦å‰‡ï¼‰
        function initializePage() {
            const now = new Date();
            const taipeiTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));

            // å¦‚æœå°åŒ—æ™‚é–“é‚„æ²’åˆ° 14:00ï¼Œé¡¯ç¤ºæ˜¨å¤©
            let targetDate;
            if (taipeiTime.getHours() < 14) {
                targetDate = new Date(taipeiTime);
                targetDate.setDate(targetDate.getDate() - 1);
            } else {
                targetDate = taipeiTime;
            }

            const dateStr = targetDate.toISOString().split('T')[0];
            selectedDate = dateStr;
            currentDate = dateStr;

            // Initialize calendar to current month
            calendarYear = targetDate.getFullYear();
            calendarMonth = targetDate.getMonth();
            document.getElementById('monthSelect').value = calendarMonth;

            // Update calendar display
            const displayText = `${targetDate.getFullYear()}/${String(targetDate.getMonth() + 1).padStart(2, '0')}/${String(targetDate.getDate()).padStart(2, '0')}`;
            document.getElementById('selectedDateText').textContent = displayText;

            loadGames(dateStr);
        }

        // Calendar Functions
        function toggleCalendar() {
            const dropdown = document.getElementById('calendarDropdown');
            dropdown.classList.toggle('active');
            if (dropdown.classList.contains('active')) {
                renderCalendar();
            }
        }

        function renderCalendar() {
            const monthSelect = document.getElementById('monthSelect');
            calendarMonth = parseInt(monthSelect.value);

            const daysContainer = document.getElementById('calendarDays');
            daysContainer.innerHTML = '';

            // Get first day of month
            const firstDay = new Date(calendarYear, calendarMonth, 1);
            const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
            const startDay = firstDay.getDay(); // 0 = Sunday

            // Get previous month's last days
            const prevMonthLastDay = new Date(calendarYear, calendarMonth, 0).getDate();

            // Get today for highlighting
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            // Render days
            let dayCount = 1;
            let nextMonthDay = 1;

            for (let i = 0; i < 42; i++) { // 6 weeks max
                let dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';

                if (i < startDay) {
                    // Previous month's days
                    const day = prevMonthLastDay - startDay + i + 1;
                    dayElement.textContent = day;
                    dayElement.classList.add('other-month');
                    const prevMonth = calendarMonth - 1 < 0 ? 11 : calendarMonth - 1;
                    const prevYear = calendarMonth - 1 < 0 ? calendarYear - 1 : calendarYear;
                    const dateStr = `${prevYear}-${String(prevMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    dayElement.onclick = () => selectDate(dateStr);
                } else if (dayCount <= lastDay.getDate()) {
                    // Current month's days
                    dayElement.textContent = dayCount;
                    const dateStr = `${calendarYear}-${String(calendarMonth + 1).padStart(2, '0')}-${String(dayCount).padStart(2, '0')}`;

                    if (dateStr === todayStr) {
                        dayElement.classList.add('today');
                    }

                    if (selectedDate && dateStr === selectedDate) {
                        dayElement.classList.add('selected');
                    }

                    dayElement.onclick = () => selectDate(dateStr);
                    dayCount++;
                } else {
                    // Next month's days
                    dayElement.textContent = nextMonthDay;
                    dayElement.classList.add('other-month');
                    const nextMonth = calendarMonth + 1 > 11 ? 0 : calendarMonth + 1;
                    const nextYear = calendarMonth + 1 > 11 ? calendarYear + 1 : calendarYear;
                    const dateStr = `${nextYear}-${String(nextMonth + 1).padStart(2, '0')}-${String(nextMonthDay).padStart(2, '0')}`;
                    dayElement.onclick = () => selectDate(dateStr);
                    nextMonthDay++;
                }

                daysContainer.appendChild(dayElement);
            }
        }

        function changeMonth(direction) {
            calendarMonth += direction;
            if (calendarMonth < 0) {
                calendarMonth = 11;
                calendarYear--;
            } else if (calendarMonth > 11) {
                calendarMonth = 0;
                calendarYear++;
            }

            document.getElementById('monthSelect').value = calendarMonth;
            renderCalendar();
        }

        function selectDate(dateStr) {
            selectedDate = dateStr;
            currentDate = dateStr;

            // Update display text
            const dateObj = new Date(dateStr);
            const displayText = `${dateObj.getFullYear()}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${String(dateObj.getDate()).padStart(2, '0')}`;
            document.getElementById('selectedDateText').textContent = displayText;

            // Close calendar
            document.getElementById('calendarDropdown').classList.remove('active');

            // Load games for selected date
            loadGames(dateStr);
        }

        // è·³è½‰åˆ°æ­·å²æ¯”è³½ä¸¦è‡ªå‹•å±•é–‹
        async function navigateToHistoricalGame(gameId, gameDate, event) {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼ˆé¿å…è§¸ç™¼å…¶ä»–é»æ“Šäº‹ä»¶ï¼‰
            event.stopPropagation();

            // 1. è·³è½‰åˆ°è©²æ—¥æœŸ
            selectedDate = gameDate;
            currentDate = gameDate;

            // Update display text
            const dateObj = new Date(gameDate);
            const displayText = `${dateObj.getFullYear()}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${String(dateObj.getDate()).padStart(2, '0')}`;
            document.getElementById('selectedDateText').textContent = displayText;

            // 2. è¼‰å…¥è©²æ—¥æœŸçš„æ¯”è³½è³‡æ–™
            await loadGames(gameDate);

            // 3. ç­‰å¾… DOM æ¸²æŸ“å®Œæˆå¾Œï¼Œæ‰¾åˆ°ä¸¦å±•é–‹è©²æ¯”è³½
            setTimeout(() => {
                // æ‰¾åˆ°æ‰€æœ‰æ¯”è³½å¡ç‰‡
                const gameCards = document.querySelectorAll('.game-card');

                // éæ­·æ‰€æœ‰æ¯”è³½ï¼Œæ‰¾åˆ°åŒ¹é…çš„ gameId
                gameCards.forEach(card => {
                    // å¾å¡ç‰‡å…§å®¹ä¸­æŸ¥æ‰¾ gameIdï¼ˆé€éè¿‘æœŸæˆ°ç¸¾çš„ data-game-idï¼‰
                    const historyGames = card.querySelectorAll('.history-game');
                    let isTargetGame = false;

                    // æª¢æŸ¥é€™å¼µå¡ç‰‡çš„æˆ°ç¸¾ä¸­æ˜¯å¦åŒ…å«ç›®æ¨™ gameId
                    historyGames.forEach(histGame => {
                        if (histGame.dataset.gameId === gameId) {
                            isTargetGame = true;
                        }
                    });

                    // å¦‚æœæ‰¾åˆ°ç›®æ¨™æ¯”è³½ï¼Œå±•é–‹å®ƒä¸¦æ²å‹•åˆ°è©²ä½ç½®
                    if (isTargetGame) {
                        // å±•é–‹æ¯”è³½å¡ç‰‡ï¼ˆç§»é™¤ collapsed classï¼‰
                        card.classList.remove('collapsed');

                        // æ²å‹•åˆ°è©²æ¯”è³½ä½ç½®
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });

                        // é«˜äº®é¡¯ç¤ºè©²æ¯”è³½ï¼ˆæ·»åŠ è‡¨æ™‚å‹•ç•«æ•ˆæœï¼‰
                        card.style.backgroundColor = '#fff3cd';
                        setTimeout(() => {
                            card.style.backgroundColor = '';
                            card.style.transition = 'background-color 1s ease';
                        }, 2000);
                    }
                });
            }, 300); // çµ¦äºˆ 300ms è®“ DOM æ¸²æŸ“å®Œæˆ
        }

        // Close calendar when clicking outside
        document.addEventListener('click', function(event) {
            const calendarPicker = document.querySelector('.calendar-picker');
            const calendarDropdown = document.getElementById('calendarDropdown');

            if (calendarDropdown.classList.contains('active') &&
                !calendarPicker.contains(event.target)) {
                calendarDropdown.classList.remove('active');
            }
        });

        initializePage();

        // æ¯ 5 åˆ†é˜è‡ªå‹•æ›´æ–°ï¼ˆåªåœ¨æŸ¥çœ‹ä»Šå¤©çš„æ¯”è³½æ™‚ï¼Œä¸”ä½¿ç”¨ forceReloadï¼‰
        setInterval(() => {
            const now = new Date();
            const taipeiTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));

            let todayDate;
            if (taipeiTime.getHours() < 14) {
                todayDate = new Date(taipeiTime);
                todayDate.setDate(todayDate.getDate() - 1);
            } else {
                todayDate = taipeiTime;
            }

            const todayStr = todayDate.toISOString().split('T')[0];
            if (currentDate === todayStr && !isLoading) {
                loadGames(currentDate, true); // forceReload = true
            }
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
